services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: netbox-postgres
    environment:
      POSTGRES_DB: netbox
      POSTGRES_USER: netbox
      POSTGRES_PASSWORD: netbox123
    volumes:
      - netbox-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netbox"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and task queue
  redis:
    image: redis:7-alpine
    container_name: netbox-redis
    command: redis-server --appendonly yes
    volumes:
      - netbox-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NetBox Application
  netbox:
    image: netboxcommunity/netbox:v4.2
    container_name: netbox
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: netbox123
      DB_HOST: postgres
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DATABASE: 0
      REDIS_CACHE_DATABASE: 1
      # NetBox settings
      SECRET_KEY: "netbox-test-secret-key-change-in-production-at-least-50-chars"
      ALLOWED_HOSTS: "*"
      SUPERUSER_NAME: admin
      SUPERUSER_EMAIL: admin@example.com
      SUPERUSER_PASSWORD: admin123
      SUPERUSER_API_TOKEN: 0123456789abcdef0123456789abcdef01234567
      # Device encryption key for onboarding
      NETBOX_DEVICE_ENCRYPTION_KEY: "XPmjtY0wwxQbD0ezEMDhGlAo2_JGXb6yB4yp5I-MnGA="
      # Skip startup scripts that might fail
      SKIP_SUPERUSER: "false"
    ports:
      - "8000:8080"
    volumes:
      - ./netbox/scripts:/opt/netbox/netbox/scripts:ro
      - netbox-media-files:/opt/netbox/netbox/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # NetBox Worker (for background tasks like webhooks)
  netbox-worker:
    image: netboxcommunity/netbox:v4.2
    container_name: netbox-worker
    depends_on:
      netbox:
        condition: service_healthy
    command: /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    environment:
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: netbox123
      DB_HOST: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DATABASE: 0
      SECRET_KEY: "netbox-test-secret-key-change-in-production-at-least-50-chars"
      NETBOX_DEVICE_ENCRYPTION_KEY: "XPmjtY0wwxQbD0ezEMDhGlAo2_JGXb6yB4yp5I-MnGA="

  # Mock Telemetry Service (to test webhooks)
  telemetry-mock:
    build:
      context: .
      dockerfile: Dockerfile.telemetry-mock
    container_name: telemetry-mock
    ports:
      - "5000:5000"
    environment:
      NETBOX_DEVICE_ENCRYPTION_KEY: "XPmjtY0wwxQbD0ezEMDhGlAo2_JGXb6yB4yp5I-MnGA="

  # Device Onboarding API (single-call device creation with IP)
  onboarding-api:
    build:
      context: .
      dockerfile: Dockerfile.onboarding-api
    container_name: onboarding-api
    depends_on:
      - netbox
    ports:
      - "5001:5001"
    environment:
      NETBOX_URL: "http://netbox:8080"
      NETBOX_TOKEN: "0123456789abcdef0123456789abcdef01234567"
      NETBOX_DEVICE_ENCRYPTION_KEY: "XPmjtY0wwxQbD0ezEMDhGlAo2_JGXb6yB4yp5I-MnGA="

  # Device Reachability Monitor (continuous ping monitoring)
  device-monitor:
    build:
      context: .
      dockerfile: Dockerfile.device-monitor
    container_name: device-monitor
    depends_on:
      netbox:
        condition: service_healthy
    environment:
      NETBOX_URL: "http://netbox:8080"
      NETBOX_TOKEN: "0123456789abcdef0123456789abcdef01234567"
      PING_INTERVAL: "60"
      PING_COUNT: "3"
      PING_TIMEOUT: "2"
    restart: unless-stopped

volumes:
  netbox-postgres-data:
  netbox-redis-data:
  netbox-media-files:
